#!/usr/bin/env node

// –ó–∞–≥—Ä—É–∂–∞–µ–º .env —Ñ–∞–π–ª –î–û –≤—Å–µ–≥–æ –æ—Å—Ç–∞–ª—å–Ω–æ–≥–æ
const path = require('path')
const fs = require('fs')
const dotenv = require('dotenv')

const projectRoot = path.join(__dirname, '..', '..', '..')

// –ü–∞—Ç—á–∏–º @langchain/core —á—Ç–æ–±—ã –æ—Ç–∫–ª—é—á–∏—Ç—å HTTP –∑–∞–ø—Ä–æ—Å—ã –∫ tiktoken
// –≠—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∫—É –ø—Ä–∏ –ø–æ–¥—Å—á—ë—Ç–µ —Ç–æ–∫–µ–Ω–æ–≤
try {
    const langchainCore = require('@langchain/core/language_models/base')
    
    // –ü–∞—Ç—á–∏–º BaseChatModel.prototype.getNumTokens
    if (langchainCore.BaseChatModel) {
        langchainCore.BaseChatModel.prototype.getNumTokens = async function(content) {
            // –ü—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω—ã–π –ø–æ–¥—Å—á—ë—Ç: ~4 —Å–∏–º–≤–æ–ª–∞ –Ω–∞ —Ç–æ–∫–µ–Ω
            return Math.ceil(content.length / 4)
        }
    }
    
    // –ü–∞—Ç—á–∏–º BaseLanguageModel.prototype.getNumTokens
    if (langchainCore.BaseLanguageModel) {
        langchainCore.BaseLanguageModel.prototype.getNumTokens = async function(content) {
            // –ü—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω—ã–π –ø–æ–¥—Å—á—ë—Ç: ~4 —Å–∏–º–≤–æ–ª–∞ –Ω–∞ —Ç–æ–∫–µ–Ω
            return Math.ceil(content.length / 4)
        }
    }
} catch (err) {
    console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–ø–∞—Ç—á–∏—Ç—å @langchain/core:', err.message)
}

// –ü—ã—Ç–∞–µ–º—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å .env –∏–∑ —Ä–∞–∑–Ω—ã—Ö –º–µ—Å—Ç (–≤ –ø–æ—Ä—è–¥–∫–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞)
const envPaths = [
    path.join(projectRoot, 'packages', 'server', '.env'),  // packages/server/.env (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç)
    path.join(projectRoot, '.env')                          // –∫–æ—Ä–µ–Ω—å (fallback)
]

envPaths.forEach(envPath => {
    if (fs.existsSync(envPath)) {
        console.log(`üìÇ Attempting to load .env from: ${envPath}`)
        const result = dotenv.config({ path: envPath, override: false })
        if (result.error) {
            console.log(`‚ùå Error loading .env: ${result.error}`)
        } else {
            console.log(`‚úÖ Loaded .env from: ${envPath}`)
            console.log(`üìä DATABASE_TYPE: ${process.env.DATABASE_TYPE}`)
            console.log(`üìä DATABASE_HOST: ${process.env.DATABASE_HOST}`)
            console.log(`üìä PORT: ${process.env.PORT}`)
        }
    }
})

// –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º Enterprise –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
if (process.env._EE_LICENSE_KEY && !process.env.OSMI_EE_LICENSE_KEY) {
    process.env.OSMI_EE_LICENSE_KEY = process.env._EE_LICENSE_KEY
}
if (process.env.OSMI_AI_EE_LICENSE_KEY && !process.env.OSMI_EE_LICENSE_KEY) {
    process.env.OSMI_EE_LICENSE_KEY = process.env.OSMI_AI_EE_LICENSE_KEY
}
if (process.env.OSMI_EE_LICENSE_KEY) {
    console.log(`üîë Enterprise license key loaded`)
}
if (process.env.OFFLINE === 'true') {
    console.log(`üîå Running in OFFLINE mode`)
}

// –°–æ–∑–¥–∞—ë–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –∏–∑ .env
const dirsToCreate = []

// –î–æ–±–∞–≤–ª—è–µ–º LOG_PATH –µ—Å–ª–∏ –æ–Ω –∑–∞–¥–∞–Ω
if (process.env.LOG_PATH) {
    dirsToCreate.push(process.env.LOG_PATH)
    console.log(`üìÅ Will create LOG_PATH: ${process.env.LOG_PATH}`)
}

// –î–æ–±–∞–≤–ª—è–µ–º BLOB_STORAGE_PATH –µ—Å–ª–∏ –æ–Ω –∑–∞–¥–∞–Ω
if (process.env.BLOB_STORAGE_PATH) {
    dirsToCreate.push(process.env.BLOB_STORAGE_PATH)
    dirsToCreate.push(path.join(process.env.BLOB_STORAGE_PATH, 'uploads'))
    console.log(`üìÅ Will create BLOB_STORAGE_PATH: ${process.env.BLOB_STORAGE_PATH}`)
}

// –î–æ–±–∞–≤–ª—è–µ–º DATABASE_PATH –µ—Å–ª–∏ –æ–Ω –∑–∞–¥–∞–Ω –∏ —ç—Ç–æ –Ω–µ sqlite
if (process.env.DATABASE_PATH && process.env.DATABASE_TYPE !== 'postgres') {
    dirsToCreate.push(process.env.DATABASE_PATH)
    console.log(`üìÅ Will create DATABASE_PATH: ${process.env.DATABASE_PATH}`)
}

// –°–æ–∑–¥–∞—ë–º –≤—Å–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
dirsToCreate.forEach(dir => {
    if (!fs.existsSync(dir)) {
        try {
            fs.mkdirSync(dir, { recursive: true })
            console.log(`‚úÖ Created directory: ${dir}`)
        } catch (err) {
            console.error(`‚ùå Failed to create directory ${dir}:`, err.message)
        }
    } else {
        console.log(`‚úì Directory exists: ${dir}`)
    }
})

process.env.DEBUG = ''

const oclif = require('@oclif/core')
oclif.run().then(require('@oclif/core/flush')).catch(require('@oclif/core/handle'))
