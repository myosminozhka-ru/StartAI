#!/usr/bin/env node

// Ð—Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ .env Ñ„Ð°Ð¹Ð» Ð”Ðž Ð²ÑÐµÐ³Ð¾ Ð¾ÑÑ‚Ð°Ð»ÑŒÐ½Ð¾Ð³Ð¾
const path = require('path')
const fs = require('fs')
const dotenv = require('dotenv')

const projectRoot = path.join(__dirname, '..', '..', '..')

// ÐŸÐ°Ñ‚Ñ‡Ð¸Ð¼ @langchain/core Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð¾Ñ‚ÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÑŒ HTTP Ð·Ð°Ð¿Ñ€Ð¾ÑÑ‹ Ðº tiktoken
// Ð­Ñ‚Ð¾ Ð¿Ñ€ÐµÐ´Ð¾Ñ‚Ð²Ñ€Ð°Ñ‰Ð°ÐµÑ‚ Ð±Ð»Ð¾ÐºÐ¸Ñ€Ð¾Ð²ÐºÑƒ Ð¿Ñ€Ð¸ Ð¿Ð¾Ð´ÑÑ‡Ñ‘Ñ‚Ðµ Ñ‚Ð¾ÐºÐµÐ½Ð¾Ð²
try {
    const langchainCore = require('@langchain/core/language_models/base')
    
    // ÐŸÐ°Ñ‚Ñ‡Ð¸Ð¼ BaseChatModel.prototype.getNumTokens
    if (langchainCore.BaseChatModel) {
        langchainCore.BaseChatModel.prototype.getNumTokens = async function(content) {
            // ÐŸÑ€Ð¸Ð±Ð»Ð¸Ð·Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ð¹ Ð¿Ð¾Ð´ÑÑ‡Ñ‘Ñ‚: ~4 ÑÐ¸Ð¼Ð²Ð¾Ð»Ð° Ð½Ð° Ñ‚Ð¾ÐºÐµÐ½
            return Math.ceil(content.length / 4)
        }
    }
    
    // ÐŸÐ°Ñ‚Ñ‡Ð¸Ð¼ BaseLanguageModel.prototype.getNumTokens
    if (langchainCore.BaseLanguageModel) {
        langchainCore.BaseLanguageModel.prototype.getNumTokens = async function(content) {
            // ÐŸÑ€Ð¸Ð±Ð»Ð¸Ð·Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ð¹ Ð¿Ð¾Ð´ÑÑ‡Ñ‘Ñ‚: ~4 ÑÐ¸Ð¼Ð²Ð¾Ð»Ð° Ð½Ð° Ñ‚Ð¾ÐºÐµÐ½
            return Math.ceil(content.length / 4)
        }
    }
} catch (err) {
    console.warn('ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¿Ñ€Ð¾Ð¿Ð°Ñ‚Ñ‡Ð¸Ñ‚ÑŒ @langchain/core:', err.message)
}

if (!process.env.BLOB_STORAGE_PATH) {
    process.env.BLOB_STORAGE_PATH = path.join(projectRoot, 'storage')
}
if (!process.env.DATABASE_PATH) {
    process.env.DATABASE_PATH = projectRoot
}
if (!process.env.LOG_PATH) {
    process.env.LOG_PATH = path.join(projectRoot, 'logs')
}

// ÐŸÑ‹Ñ‚Ð°ÐµÐ¼ÑÑ Ð·Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚ÑŒ .env Ð¸Ð· Ñ€Ð°Ð·Ð½Ñ‹Ñ… Ð¼ÐµÑÑ‚ (Ð² Ð¿Ð¾Ñ€ÑÐ´ÐºÐµ Ð¿Ñ€Ð¸Ð¾Ñ€Ð¸Ñ‚ÐµÑ‚Ð°)
const envPaths = [
    path.join(projectRoot, 'packages', 'server', '.env'),  // packages/server/.env (Ð¿Ñ€Ð¸Ð¾Ñ€Ð¸Ñ‚ÐµÑ‚)
    path.join(projectRoot, '.env')                          // ÐºÐ¾Ñ€ÐµÐ½ÑŒ (fallback)
]

envPaths.forEach(envPath => {
    if (fs.existsSync(envPath)) {
        console.log(`ðŸ“‚ Attempting to load .env from: ${envPath}`)
        const result = dotenv.config({ path: envPath, override: false })
        if (result.error) {
            console.log(`âŒ Error loading .env: ${result.error}`)
        } else {
            console.log(`âœ… Loaded .env from: ${envPath}`)
            console.log(`ðŸ“Š DATABASE_TYPE: ${process.env.DATABASE_TYPE}`)
            console.log(`ðŸ“Š DATABASE_HOST: ${process.env.DATABASE_HOST}`)
            console.log(`ðŸ“Š PORT: ${process.env.PORT}`)
        }
    }
})

const dirsToCreate = [
    path.join(projectRoot, '.OSMI'),
    path.join(process.env.BLOB_STORAGE_PATH, 'uploads'),
    path.join(projectRoot, 'logs')
]

dirsToCreate.forEach(dir => {
    if (!fs.existsSync(dir)) {
        fs.mkdirSync(dir, { recursive: true })
    }
})

process.env.DEBUG = ''

const oclif = require('@oclif/core')
oclif.run().then(require('@oclif/core/flush')).catch(require('@oclif/core/handle'))
