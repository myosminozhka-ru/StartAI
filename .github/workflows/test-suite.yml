name: ðŸ§ª OSMI AI Test Suite

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:
  schedule:
    # Nightly tests at 2 AM UTC
    - cron: '0 2 * * *'

permissions:
  contents: read
  checks: write
  pull-requests: write

jobs:
  # ðŸ”§ Unit Tests
  unit-tests:
    name: ðŸ”§ Unit Tests
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [18.15.0, 20.x]
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9.0.4

      - name: ðŸŸ¢ Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'pnpm'
        env:
          NODE_OPTIONS: '--experimental-vm-modules'

      - name: ðŸ“¥ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ðŸ”§ Run unit tests (Components)
        run: |
          cd packages/osmi-ai-components
          pnpm test --coverage --watchAll=false
        env:
          CI: true

      - name: ðŸ”§ Run unit tests (Server)
        run: |
          cd packages/server
          pnpm test:unit
        env:
          CI: true
          NODE_OPTIONS: '--experimental-vm-modules'

      - name: ðŸ“Š Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          file: ./packages/osmi-ai-components/coverage/lcov.info
          flags: unit-tests
          name: unit-tests-${{ matrix.node-version }}

      - name: ðŸ“‹ Publish Test Results
        uses: dorny/test-reporter@v1
        if: always()
        with:
          name: Unit Tests (${{ matrix.node-version }})
          path: packages/osmi-ai-components/coverage/junit.xml
          reporter: jest-junit

  # ðŸ”Œ API Tests  
  api-tests:
    name: ðŸ”Œ API Tests
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: test123
          POSTGRES_USER: osmi_test
          POSTGRES_DB: osmi_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9.0.4

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18.15.0
          cache: 'pnpm'

      - name: ðŸ“¥ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ðŸ—ï¸ Build project
        run: pnpm build
        env:
          NODE_OPTIONS: '--max_old_space_size=4096'

      - name: ðŸ”Œ Run API tests
        run: |
          cd packages/server
          pnpm test:api --coverage --watchAll=false
        env:
          CI: true
          NODE_ENV: test
          NODE_OPTIONS: '--experimental-vm-modules'
          DATABASE_TYPE: postgres
          DATABASE_HOST: localhost
          DATABASE_PORT: 5432
          DATABASE_USERNAME: osmi_test
          DATABASE_PASSWORD: test123
          DATABASE_NAME: osmi_test
          OSMI_AI_USERNAME: test
          OSMI_AI_PASSWORD: test123

      - name: ðŸ“Š Upload API coverage
        uses: codecov/codecov-action@v3
        with:
          file: ./packages/server/coverage/lcov.info
          flags: api-tests
          name: api-tests

  # ðŸŒ E2E Tests
  e2e-tests:
    name: ðŸŒ E2E Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9.0.4

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18.15.0
          cache: 'pnpm'

      - name: ðŸ“¥ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ðŸ—ï¸ Build project
        run: pnpm build
        env:
          NODE_OPTIONS: '--max_old_space_size=4096'

      - name: ðŸŒ Run Cypress E2E tests
        uses: cypress-io/github-action@v6
        with:
          working-directory: packages/server
          start: pnpm start
          wait-on: 'http://localhost:3000'
          wait-on-timeout: 120
          browser: chrome
          record: true
          parallel: true
        env:
          CYPRESS_RECORD_KEY: ${{ secrets.CYPRESS_RECORD_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NODE_ENV: test

      - name: ðŸ“¸ Upload screenshots
        uses: actions/upload-artifact@v3
        if: failure()
        with:
          name: cypress-screenshots
          path: packages/server/cypress/screenshots

      - name: ðŸŽ¥ Upload videos
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: cypress-videos
          path: packages/server/cypress/videos

  # ðŸš€ OSMI AI Embed Tests
  embed-tests:
    name: ðŸš€ OSMI AI Embed Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9.0.4

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18.15.0
          cache: 'pnpm'

      - name: ðŸ“¥ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ðŸ—ï¸ Build project
        run: pnpm build

      - name: ðŸš€ Test OSMI AI Embed Components
        run: |
          # Test that OSMI AI embed components are properly installed
          cd packages/ui
          node -e "
            try {
              const embed = require('osmi-ai-embed-react');
              console.log('âœ… OSMI AI Embed components loaded successfully');
              console.log('Available components:', Object.keys(embed));
              if (embed.BubbleChat && embed.FullPageChat) {
                console.log('âœ… All required components available');
                process.exit(0);
              } else {
                console.log('âŒ Missing required components');
                process.exit(1);
              }
            } catch (error) {
              console.log('âŒ Failed to load OSMI AI Embed components:', error.message);
              process.exit(1);
            }
          "

      - name: ðŸ§ª Test Embed Integration
        run: |
          cd packages/server
          # Start server in background
          pnpm start &
          SERVER_PID=$!
          
          # Wait for server to start
          sleep 30
          
          # Test embed endpoints
          curl -f http://localhost:3000/api/v1/ping || exit 1
          curl -f http://localhost:3000/api/v1/public-chatflows || echo "Public chatflows endpoint not available"
          
          # Cleanup
          kill $SERVER_PID

  # ðŸ“Š Test Results Summary
  test-summary:
    name: ðŸ“Š Test Summary
    runs-on: ubuntu-latest
    needs: [unit-tests, api-tests, e2e-tests, embed-tests]
    if: always()
    
    steps:
      - name: ðŸ“‹ Generate Test Summary
        run: |
          echo "## ðŸ§ª OSMI AI Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Test Type | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”§ Unit Tests | ${{ needs.unit-tests.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”Œ API Tests | ${{ needs.api-tests.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŒ E2E Tests | ${{ needs.e2e-tests.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸš€ Embed Tests | ${{ needs.embed-tests.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ˆ Coverage Reports" >> $GITHUB_STEP_SUMMARY
          echo "- Unit Test Coverage: Available in Codecov" >> $GITHUB_STEP_SUMMARY
          echo "- API Test Coverage: Available in Codecov" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŽ¯ Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "- Review failed tests if any" >> $GITHUB_STEP_SUMMARY
          echo "- Check coverage reports" >> $GITHUB_STEP_SUMMARY
          echo "- Verify OSMI AI embed functionality" >> $GITHUB_STEP_SUMMARY

      - name: ðŸš¨ Notify on Failure
        if: needs.unit-tests.result == 'failure' || needs.api-tests.result == 'failure' || needs.e2e-tests.result == 'failure' || needs.embed-tests.result == 'failure'
        run: |
          echo "::error::One or more test suites failed. Please check the logs."
          exit 1
